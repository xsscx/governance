# Violation Patterns Database (Machine-Readable)
# Version: 2.0
# Distilled from LLMCJF post-mortems + operational experience

violations:
  - id: V-CRITICAL-001
    name: Format Specification Deviation
    severity: critical
    category: specification_compliance
    description: Explicit format ignored despite multiple corrections
    evidence_pattern:
      - User provides explicit format specification
      - Agent deviates from format 3+ times
      - Format includes structured data (JSON, CVSS, etc.)
    detection:
      - correction_count: ">= 3"
      - explicit_format_provided: true
      - output_matches_format: false
    remediation:
      - Parse format specification before output
      - Validate output against specification
      - Use schema validation for structured formats
    cost_impact:
      iterations: 8
      compliance_score_penalty: -60
    example_fingerprint: "CVSS format violation (8 iterations)"

  - id: V-CRITICAL-002
    name: Specification Non-Compliance After Consumption
    severity: critical
    category: specification_compliance
    description: Documentation consumed but not applied
    evidence_pattern:
      - Agent consumes specification document
      - Agent acknowledges specification
      - Agent violates specification in output
    detection:
      - document_consumed: true
      - acknowledgment_present: true
      - compliance_violation: true
    remediation:
      - Extract requirements before generating output
      - Checklist validation against spec
      - Reference spec in output validation
    cost_impact:
      iterations: 5
      compliance_score_penalty: -40
    example_fingerprint: "Shell prologue consumed but bash template used"

  - id: V-CRITICAL-003
    name: False Authoritative Statements
    severity: critical
    category: factual_accuracy
    description: Tool failures presented as successful facts
    evidence_pattern:
      - Tool execution fails
      - Agent reports success
      - User discovers failure later
    detection:
      - tool_exit_code: "!= 0"
      - agent_statement: "matches success pattern"
      - factual_accuracy: false
    remediation:
      - Always check exit codes
      - Report errors immediately
      - Never infer success without confirmation
    cost_impact:
      iterations: 3
      compliance_score_penalty: -30
      trust_damage: high
    example_fingerprint: "jq installation claimed but not verified"

  - id: V-HIGH-001
    name: Scope Compression
    severity: high
    category: completeness
    description: Requested content significantly reduced without authorization
    evidence_pattern:
      - User requests specific line count or completeness
      - Agent delivers significantly less (<50% of expected)
      - No explicit permission to reduce scope
    detection:
      - requested_lines: ">= 200"
      - delivered_lines: "< 100"
      - scope_reduction_authorized: false
    remediation:
      - Honor requested scope
      - Ask permission before reducing
      - Provide justification if reduction necessary
    cost_impact:
      iterations: 2
      compliance_score_penalty: -20
    example_fingerprint: "370 lines requested, 67 lines delivered"

  - id: V-HIGH-002
    name: Narrative Padding
    severity: high
    category: verbosity
    description: Excessive explanatory text beyond profile limits
    evidence_pattern:
      - Profile specifies max unrequested lines (e.g., 12)
      - Agent exceeds limit with narrative
      - Content includes apologies, meta-commentary, or padding
    detection:
      - unrequested_lines: "> profile.max_unrequested_lines"
      - contains_apologies: true
      - contains_meta_commentary: true
    remediation:
      - Count unrequested lines before output
      - Remove narrative padding
      - Replace explanations with direct action
    cost_impact:
      iterations: 1
      compliance_score_penalty: -10
    example_fingerprint: "35 unrequested lines (limit: 12)"

  - id: V-MEDIUM-001
    name: Scope Creep
    severity: medium
    category: boundaries
    description: Unrequested files or features added
    evidence_pattern:
      - User requests specific changes
      - Agent adds unrequested files/features
      - No explicit user request for additions
    detection:
      - requested_files: "< delivered_files"
      - unrequested_additions: true
      - user_authorization: false
    remediation:
      - Deliver only requested items
      - Ask before adding related features
      - Minimal change principle
    cost_impact:
      iterations: 1
      compliance_score_penalty: -10
    example_fingerprint: "Fix DNS → add firewall, monitoring, logs"

  - id: V-MEDIUM-002
    name: Known-Good Structure Regression
    severity: medium
    category: consistency
    description: Previously working structure modified without cause
    evidence_pattern:
      - Agent previously delivered working structure
      - Later session regresses to inferior approach
      - No user request for change
      - No bug fix justification
    detection:
      - previous_structure_working: true
      - current_structure_different: true
      - regression_justified: false
    remediation:
      - Reference previous working solutions
      - Maintain consistency across sessions
      - Only change with explicit reason
    cost_impact:
      iterations: 2
      compliance_score_penalty: -15
    example_fingerprint: "CJF-08 heuristic"

  - id: V-LOW-001
    name: No-Op Echo Response
    severity: low
    category: productivity
    description: Restating user input without action
    evidence_pattern:
      - User provides clear instruction
      - Agent echoes instruction
      - No tool calls made
      - No output generated
    detection:
      - tool_calls_made: 0
      - response_similarity_to_input: "> 0.8"
      - actionable_output: false
    remediation:
      - Immediately call tools
      - Skip acknowledgment
      - Direct action only
    cost_impact:
      iterations: 1
      compliance_score_penalty: -5
    example_fingerprint: "CJF-07 heuristic"

  - id: V-CRITICAL-004
    name: Destructive Operation Without Verification
    severity: critical
    category: data_safety
    description: Destructive system operation executed without verified backup
    evidence_pattern:
      - Backup/export command executed
      - File verification incomplete or absent
      - Destructive operation executed immediately
      - Data loss occurred or risked
    detection:
      - destructive_command: true
      - backup_verified: false
      - file_integrity_checked: false
      - user_confirmation_obtained: false
      - data_loss_risk: high
    remediation:
      - Verify backup file existence (Test-Path or [ -f ])
      - Verify backup file size matches expected
      - Verify backup integrity (checksum/hash)
      - Create redundant backup in different location
      - Require explicit user confirmation
      - Test restoration before deleting original
    cost_impact:
      data_loss: permanent
      trust_damage: total
      compliance_score_penalty: -50
    example_fingerprint: "WSL unregister without verified backup (17-JAN-2026)"

  - id: V-CRITICAL-005
    name: Exit Code Assumption Without Verification
    severity: critical
    category: error_handling
    description: Tool success assumed without exit code verification
    evidence_pattern:
      - Long-running command executed
      - Output truncated or incomplete
      - Success assumed from partial output
      - No exit code check performed
      - Subsequent operation failed
    detection:
      - command_output_truncated: true
      - exit_code_checked: false
      - success_assumed: true
      - subsequent_failure: true
    remediation:
      - Always check $LASTEXITCODE (PowerShell)
      - Always check $? and exit code (Bash)
      - Verify expected output file exists
      - Never assume success from partial output
      - Use explicit error handling
    cost_impact:
      iterations: varies
      compliance_score_penalty: -40
      cascading_failures: high
    example_fingerprint: "wsl export assumed success from truncated output"

# Heuristics for automated detection
heuristics:
  correction_threshold: 3  # Violations likely if corrections >= 3
  unrequested_line_limit: 12  # For strict-engineering profile
  scope_reduction_threshold: 0.5  # Warn if delivered < 50% requested
  narrative_keywords:
    - "I apologize"
    - "Let me try"
    - "Now that we"
    - "This is important because"
    - "As you can see"
  
  meta_commentary_patterns:
    - "^I'll "
    - "^Let's "
    - "^Now "
    - "should help"
    - "this will"

# Compliance scoring algorithm
scoring:
  base_score: 100
  penalties:
    correction_required: -20  # Per correction
    unrequested_line: -2  # Per line over limit
    format_deviation: -15  # Per deviation
    apology: -5  # Per apology
    user_frustration_signal: -10  # Per signal
    false_statement: -30  # Per false claim
    scope_creep_file: -5  # Per unrequested file

# Automated remediation suggestions
remediation_templates:
  format_deviation:
    - "Parse specification: extract format requirements"
    - "Generate output according to spec"
    - "Validate output before delivery"
  
  narrative_padding:
    - "Remove: apologies, meta-commentary, explanations"
    - "Count unrequested lines: {{ unrequested_lines }}"
    - "Target: ≤ {{ profile.max_unrequested_lines }} lines"
  
  scope_creep:
    - "Review user request: {{ user_request }}"
    - "Remove unrequested files: {{ unrequested_files }}"
    - "Deliver minimal changes only"
