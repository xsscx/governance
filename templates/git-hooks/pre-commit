#!/bin/bash
# Pre-commit Git Hook for Governance Compliance
# Install: ln -s ~/.copilot/templates/git-hooks/pre-commit .git/hooks/pre-commit

set -euo pipefail

echo "üîç Running governance compliance checks..."

VIOLATIONS=0

# Check 1: Shell prologue standards in workflow files
if git diff --cached --name-only | grep -q '\.github/workflows/.*\.yml$'; then
    echo "  Checking shell prologue standards..."
    
    for file in $(git diff --cached --name-only | grep '\.github/workflows/.*\.yml$'); do
        if [ -f "$file" ]; then
            # Check for bash prologue
            if grep -q "shell: bash" "$file"; then
                if ! grep -q "bash --noprofile --norc" "$file"; then
                    echo "    ‚ùå $file: Missing bash prologue flags"
                    ((VIOLATIONS++))
                fi
                if ! grep -q "BASH_ENV: /dev/null" "$file"; then
                    echo "    ‚ùå $file: Missing BASH_ENV"
                    ((VIOLATIONS++))
                fi
                if ! grep -q "set -euo pipefail" "$file"; then
                    echo "    ‚ùå $file: Missing error handling"
                    ((VIOLATIONS++))
                fi
            fi
            
            # Check for PowerShell prologue
            if grep -q "shell: pwsh" "$file"; then
                if ! grep -q "pwsh -NoProfile -NoLogo -NonInteractive" "$file"; then
                    echo "    ‚ùå $file: Missing PowerShell flags"
                    ((VIOLATIONS++))
                fi
                if ! grep -q "POWERSHELL_TELEMETRY_OPTOUT" "$file"; then
                    echo "    ‚ùå $file: Missing telemetry optout"
                    ((VIOLATIONS++))
                fi
            fi
        fi
    done
fi

# Check 2: Unrequested file modifications (excluding workflows)
CHANGED_FILES=$(git diff --cached --numstat | wc -l)
if [ "$CHANGED_FILES" -gt 15 ]; then
    echo "  ‚ö†Ô∏è  Warning: $CHANGED_FILES files changed (consider smaller commits)"
fi

# Check 3: Large line changes in single files
git diff --cached --numstat | while read added removed file; do
    if [ "$added" != "-" ] && [ "$removed" != "-" ]; then
        total=$((added + removed))
        if [ "$total" -gt 100 ]; then
            echo "  ‚ö†Ô∏è  Warning: $file has $total lines changed (review for scope creep)"
        fi
    fi
done

# Summary
if [ $VIOLATIONS -eq 0 ]; then
    echo "‚úÖ All governance checks passed"
    exit 0
else
    echo "‚ùå Found $VIOLATIONS governance violations"
    echo ""
    echo "To override (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    echo "To fix:"
    echo "  Review ~/.copilot/templates/shell/ for correct prologue standards"
    exit 1
fi
