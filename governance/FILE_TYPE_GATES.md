# File Type Gates - Mandatory Documentation Check
## Systematic Prevention of Documentation-Ignored Violations

**Version**: 1.0  
**Created**: 2026-02-03  
**Status**: MANDATORY  
**Enforcement**: Pre-action checklist before modifying gated file types

---

## Purpose

Prevent repeat violations where documentation exists but is not consulted before action.

**Problem**: Agent modifies files without checking relevant governance documentation.  
**Solution**: Mandatory documentation review for high-risk file types.

---

## File Type Gates

### Gate 1: Fuzzer Dictionaries (*.dict)

**Trigger**: Before ANY edit/create operation on `**/*.dict`

**MANDATORY Actions**:
```bash
# 1. Read governance (30 seconds)
view .copilot-sessions/governance/FUZZER_DICTIONARY_GOVERNANCE.md | grep -A20 "Rule 1"

# 2. Check previous violations (30 seconds)
ls -la .copilot-sessions/governance/DICTIONARY_FORMAT_VIOLATION*.md

# 3. Examine existing format (15 seconds)
tail -50 <target_file.dict> | grep -v '^#' | head -10
```

**PROHIBITED Actions**:
- [PROHIBITED] Edit .dict file without reading FUZZER_DICTIONARY_GOVERNANCE.md
- [PROHIBITED] Add inline comments (Rule 1 violation)
- [PROHIBITED] Use octal escapes instead of hex (Rule 2 violation)
- [PROHIBITED] Skip testing with fuzzer (Rule 3 violation)

**Verification Required**:
```bash
# After modification, MUST test
./any_fuzzer -dict=modified.dict -runs=1 2>&1 | grep "Dictionary:"
```

**Violation History**: V009 (2026-02-03), 2 previous incidents (2026-01-31)

---

### Gate 2: Fingerprint Database Files

**Trigger**: Before ANY investigation/debugging in `fingerprints/`

**MANDATORY Actions**:
```bash
# 1. Check for documentation (15 seconds)
ls fingerprints/*.md fingerprints/*.txt

# 2. Read inventory report first (30 seconds)
grep -i "SHA256\|unique\|count" fingerprints/INVENTORY_REPORT.txt

# 3. Check maintenance docs (60 seconds)
view fingerprints/MAINTENANCE_WORKFLOW.md
```

**PROHIBITED Actions**:
- [PROHIBITED] Debug without checking INVENTORY_REPORT.txt
- [PROHIBITED] Delete files during investigation
- [PROHIBITED] Assume complex bug before checking simple documentation

**Violation History**: V007 (2026-02-02) - 45 minutes wasted

---

### Gate 3: HTML Generation Scripts

**Trigger**: Before modifying `scripts/*static*site*.py`

**MANDATORY Actions**:
```bash
# 1. Check governance (if exists)
ls .copilot-sessions/governance/*HTML* 2>/dev/null

# 2. Review recent violation reports
ls llmcjf/violations/*HTML* llmcjf/violations/*UTF* 2>/dev/null

# 3. Test output after modification
python3 script.py && ls -la dist/
```

**Verification Required**:
- Test ALL page types generated
- Verify UTF-8 encoding
- Extract and test bundle
- Check for 404s on all categories

**Violation History**: V008 (2026-02-02) - False success without testing

---

### Gate 4: Copyright/License Files

**Trigger**: Before modifying ANY file containing copyright notice

**MANDATORY Actions**:
```bash
# 1. Check if ICC copyright
grep -l "International Color Consortium" <file>

# 2. If ICC copyright, HALT
# Request explicit user permission before ANY modification
```

**PROHIBITED Actions**:
- [PROHIBITED] NEVER modify ICC copyright without explicit user command
- [PROHIBITED] NEVER remove license text
- [PROHIBITED] NEVER change copyright holder

**Violation History**: V001 (2026-02-02) - CRITICAL

---

### Gate 4b: Copyright/License Verification (Post-Cleanup)

**Added:** 2026-02-07 (Lesson: COPYRIGHT_LICENSE_VERIFICATION_2026-02-07.md)

**Trigger**: After ANY copyright/license cleanup operation

**MANDATORY Verification (Multi-Pass)**:
```bash
# Pass 1: Quick pattern check (0.05s)
grep -E "Consort" *.cpp *.h *.py

# Pass 2: Full string check
grep "International Color Consortium" *.cpp *.h

# Pass 3: Generator strings
grep -E "Generated by.*" *.cpp *.h | grep -i "consortium\|icc"

# Pass 4: Case-insensitive broad search
grep -i "international color" *.cpp *.h
```

**Expected Result**: All commands return NO OUTPUT (exit code 1)

**If Match Found**:
1. Review match for context
2. Determine if legitimate technical reference or missed cleanup
3. Fix if needed
4. Re-run verification

**Common Missed Locations**:
- Generator strings in code (not just copyright blocks)
- printf/fprintf/string literals
- HTML/XML footer templates
- Version/attribution strings

**Lesson Learned (2026-02-07)**:
- Automated cleanup removed 1007 lines from 30 files
- Missed 1 generator string: `"Generated by iccAnalyzer v2.4.0 | International Color Consortium"`
- User-provided pattern `grep -E "Consort"` caught it immediately
- **Time Cost**: 10 minutes (3 correction cycles)
- **Prevention**: Multi-pass verification mandatory

**Verification Time**: 30 seconds  
**Violation Prevention**: 10-15 minutes saved

**See**: `llmcjf/lessons/COPYRIGHT_LICENSE_VERIFICATION_2026-02-07.md`

---

## Implementation

### Session Start Integration

Add to `scripts/session-start.sh`:

```bash
echo "=== File Type Gates Active ==="
echo "Before modifying:"
echo "  *.dict      → Read FUZZER_DICTIONARY_GOVERNANCE.md"
echo "  fingerprints/ → Check INVENTORY_REPORT.txt"
echo "  *copyright* → Request user permission"
echo "================================"
```

### Pre-Action Checklist

Before `edit` or `create` tool call on gated file:

1. **Identify file type** (extension/path pattern)
2. **Check gate requirements** (this document)
3. **Read mandatory documentation** (view tool)
4. **Verify compliance** (understanding rules)
5. **ONLY THEN proceed** with modification

### Automation (Future)

```python
# Proposed: Pre-action validation
GATES = {
    "*.dict": {
        "required_docs": [".copilot-sessions/governance/FUZZER_DICTIONARY_GOVERNANCE.md"],
        "prohibited_patterns": [r'^".*".*#'],  # Inline comments
        "test_command": "./fuzzer -dict={file} -runs=1"
    },
    "fingerprints/*": {
        "required_docs": ["fingerprints/INVENTORY_REPORT.txt"],
        "check_before_debug": True
    }
}
```

---

## Enforcement Protocol

### Before Modification

**MUST answer YES to all:**
- [ ] Identified file type gate
- [ ] Read all required documentation
- [ ] Checked previous violation reports
- [ ] Examined existing file format/patterns
- [ ] Understand all prohibited actions
- [ ] Know verification procedure

### After Modification

**MUST complete all:**
- [ ] Tested with actual tool (if applicable)
- [ ] Verified output/format
- [ ] Checked for errors
- [ ] Compared before/after state
- [ ] Evidence captured

### If Gate Skipped

**Consequences**:
- Violation recorded
- Counter incremented
- User time wasted
- Trust damaged
- Pattern continues

---

## Gate Effectiveness Metrics

### Target Success Rate
- **Goal**: 100% compliance (zero violations after gates active)
- **Measurement**: Violations prevented / Total gated modifications
- **Review**: Monthly or after any violation

### Current Baseline (Before Gates)
- Dictionary violations: 3 incidents (100% failure rate)
- Documentation ignored: 2 critical incidents
- Total gated file violations: 5+

### Expected Improvement
- First month: 80% compliance (learning period)
- Second month: 95% compliance (habit formation)
- Third month+: 100% compliance (systematic prevention)

---

## User Override

If user explicitly instructs action that would violate gate:

```
User: "Add inline comment to dictionary entry X"

Response: "Gate violation detected. FUZZER_DICTIONARY_GOVERNANCE.md Rule 1 
prohibits inline comments (LibFuzzer parse error). Options:
1. Add comment on separate line (compliant)
2. Override governance (requires explicit confirmation)
Recommend option 1."
```

User must explicitly confirm override: "Yes, override governance Rule 1"

---

## Violation Response

### If Gate Was Bypassed

1. **Immediate**: Document as violation
2. **Analysis**: Why was gate bypassed?
3. **Fix**: Apply gate retroactively
4. **Update**: Strengthen gate if needed
5. **Report**: User notification

### If Gate Failed to Prevent

1. **Immediate**: Fix the issue
2. **Analysis**: Why did gate fail?
3. **Update**: Improve gate logic
4. **Test**: Verify improved gate would catch
5. **Document**: Update this file

---

## Gate Activation Checklist

For each session start:

```bash
# Load gates into working context
cat .copilot-sessions/governance/FILE_TYPE_GATES.md | grep "^### Gate"

# Display active gates
echo "Active file type gates: .dict, fingerprints/, copyright"

# Confirm understanding
echo "Acknowledged: Will consult documentation before modifying gated files"
```

---

## Critical Gates Summary

| File Pattern | Required Doc | Test Required | Violations Prevented |
|--------------|-------------|---------------|---------------------|
| **/*.dict | FUZZER_DICTIONARY_GOVERNANCE.md | fuzzer -dict -runs=1 | V009, 2 previous |
| fingerprints/* | INVENTORY_REPORT.txt | N/A | V007 |
| *copyright* | User permission | N/A | V001 |
| scripts/*html*.py | Previous violations | Full page test | V008 |

---

## Success Criteria

**Gate is successful if:**
1. [OK] Agent reads documentation before action
2. [OK] Agent follows documented rules
3. [OK] Zero violations of gated file types
4. [OK] User time not wasted on preventable errors

**Gate needs improvement if:**
1. [FAIL] Violation occurs despite gate
2. [FAIL] Documentation not consulted
3. [FAIL] Rules not understood
4. [FAIL] User must correct preventable error

---

## Examples

### Example 1: Dictionary Modification (Correct)

```
User: "Add new entry to icc_multitag_fuzzer.dict"

Agent actions:
1. View .copilot-sessions/governance/FUZZER_DICTIONARY_GOVERNANCE.md
2. Note Rule 1: No inline comments
3. Check existing file: tail -20 fuzzers/specialized/icc_multitag_fuzzer.dict
4. Observe: All entries are "string" format, no inline comments
5. Add entry: "new_entry" (compliant format)
6. Test: ./fuzzer -dict=file.dict -runs=1
7. Verify: "Dictionary: N entries" appears
8. Done
```

**Result**: [OK] No violation, rule followed, testing completed

### Example 2: Fingerprint Investigation (Correct)

```
User: "Why is SHA256 count showing 0?"

Agent actions:
1. ls fingerprints/*.txt fingerprints/*.md
2. View fingerprints/INVENTORY_REPORT.txt
3. grep "SHA256\|Unique" INVENTORY_REPORT.txt
4. Find answer in 30 seconds
5. Report to user

Result: "Unique SHA256 Hashes: 50 (from INVENTORY_REPORT.txt line 12)"
```

**Result**: [OK] No debugging, documentation consulted, answer found quickly

### Example 3: Dictionary Modification (Violation Example)

```
User: "Add new entry to icc_multitag_fuzzer.dict"

Agent actions:
1. [FAIL] Skip documentation check
2. [FAIL] Add entry with inline comment: "entry"  # Uses: 1234
3. [FAIL] Skip testing
4. User runs fuzzer → Parse error
5. Fix required

Result: [FAIL] VIOLATION V009 - Gate bypassed
```

**Result**: [FAIL] Violation occurred, user time wasted, pattern continues

---

## Conclusion

**The solution is systematic:** Before modifying gated file types, MUST consult documentation.

**The mechanism is simple:** File pattern → Documentation requirement → Read docs → Follow rules

**The enforcement is mandatory:** No exceptions. Gates exist to prevent documented patterns.

**The goal is zero violations:** After gates active, gated file violations should not occur.

---

**Status**: ACTIVE  
**Review**: After each gated file modification  
**Next Update**: After first gate prevents violation OR first gate bypass detected  
**Effectiveness**: To be measured (baseline: 5+ violations, target: 0)

## Distribution Packages (Added 2026-02-03)

| File Pattern | Required Action | Violation Prevented |
|-------------|----------------|---------------------|
| *.tar.gz (distribution) | H013: Extract and test before claiming success | V012 (untested -nf flag) |
| *.zip (distribution) | H013: Test all claimed features | V010 (untested build) |
| release packages | Test from user perspective | V008 (untested HTML bundle) |

**Mandatory Testing Protocol:**
1. Extract package to clean directory
2. Test primary use case
3. Test ALL new/changed features claimed in package
4. Verify help text / version strings
5. Only claim success if ALL tests pass

**Time cost:** 30 seconds  
**Violation cost:** 10-20 minutes + user discovers bugs

**Rule:** If you claim it works in the package, PROVE you tested it.

---

## Gate 4: Build Status Claims (H019)

**Trigger**: ANY claim about build/test success or failure

**Required**: Check logs BEFORE claiming status

### Mandatory Pre-Claim Verification

```bash
# BEFORE claiming "build succeeded/failed" or "artifacts exist/missing":

# 1. Find logs (5s)
find . -name "*build*.log" -o -name "*make*.log" -mtime -7 | head -5

# 2. Check status (10s)
tail -100 <logfile> | grep -i "error\|failed\|success\|built target\|100%"

# 3. Find artifacts (5s)
find <expected-location> -name "<expected-pattern>" -type f

# 4. If discrepancy (log vs reality) → INVESTIGATE, don't assume

# 5. Report with evidence (include log file name + status lines)
```

**Time Cost**: 20 seconds  
**Violation Cost**: 16-45 minutes  
**ROI**: 60× (60 minutes saved per 1 minute invested)

### Trigger Phrases

| Phrase | Action Required |
|--------|----------------|
| "build failed" | H019 protocol |
| "build succeeded" | H019 protocol |
| "artifacts missing" | H019 protocol + find command |
| "not found" | H019 protocol + find command |
| "tests passed" | H019 protocol with test logs |
| "tests failed" | H019 protocol with test logs |
| "no errors" | H019 protocol |
| "compilation error" | H019 protocol |

### Related Violations

**V018** (2026-02-03): False Testing Claims
- Claimed: "WASM builds don't exist"
- Reality: Log showed all 16 tools built successfully
- Cause: Didn't check logs, trusted empty directory
- Cost: 16 minutes wasted

**V006** (2026-02-02): False Diagnosis  
- Claimed: "SHA256 extraction bug in C++"
- Reality: Answer in 3 documentation files
- Cause: Didn't check docs before debugging
- Cost: 45 minutes wasted

### Enforcement: TIER 1 (Hard Stop)

**NO EXCEPTIONS**:
- Before typing "build failed" → run H019 protocol
- Before typing "not found" → run H019 protocol
- Before typing "tests passed" → run H019 protocol

**Rationale**:
- 64% of violations are false success/failure claims
- H011 violated within 24 hours of creation
- Pattern persists despite documentation
- 20-second investment prevents 20-minute waste

### Quick Reference Card

```
═══════════════════════════════════════════════════════
  BEFORE claiming build/test status:
───────────────────────────────────────────────────────
  ☐ Found log file?
  ☐ Read last 50-100 lines?
  ☐ Checked for error/success indicators?
  ☐ Ran find for expected artifacts?
  ☐ Investigated discrepancies?
───────────────────────────────────────────────────────
  If ANY box unchecked → DON'T make the claim
═══════════════════════════════════════════════════════
```

---

## Summary: All Active Gates

| Gate | Trigger | Action | Heuristic |
|------|---------|--------|-----------|
| Gate 1 | `*.dict` files | Read FUZZER_DICTIONARY_GOVERNANCE.md | N/A |
| Gate 2 | `fingerprints/*` files | Read INVENTORY_REPORT.txt | N/A |
| Gate 3 | Copyright/license mods | User permission required | N/A |
| Gate 4 | Build/test status claims | H019 Logs-First-Protocol | H019 |
| Gate 5 | `.github/workflows/*.yml` | Check WORKFLOW_REFERENCE_BASELINE.md + ci-latest-release.yml | H009 |

**All gates mandatory before file modification or status claims**

---


---

### .github/workflows/*.yml - CI/CD Workflows
**Gate Type:** WORKING-REFERENCE-CHECK-MANDATORY  
**Risk:** False diagnosis, 50+ min wasted, wrong fixes  
**Added:** 2026-02-05 (V020)  
**Updated:** 2026-02-06 (CFL Success + Artifact Pattern)  
**Full Documentation:** 
- `.copilot-sessions/governance/WORKFLOW_GOVERNANCE.md` (comprehensive)
- `.copilot-sessions/governance/WORKFLOW_REFERENCE_BASELINE.md` (source of truth)
- `.copilot-sessions/governance/ARTIFACT_UPLOAD_PATTERNS_2026-02-06.md` (artifact uploads)

**MANDATORY REFERENCES (Check FIRST):**
1. **ci-latest-release.yml** - Production validated, known good
   - URL: https://github.com/xsscx/user-controllable-input/blob/master/.github/workflows/ci-latest-release.yml
   - Status: ✅ PRODUCTION
   
2. **ci-comprehensive-build-test.yml** - CFL campaign success
   - URL: https://github.com/xsscx/user-controllable-input/blob/cfl/.github/workflows/ci-comprehensive-build-test.yml
   - Run: https://github.com/xsscx/user-controllable-input/actions/runs/21736364210
   - Status: ✅ 100% SUCCESS (26/26 jobs)
   - Validated: 2026-02-06

**Before modifying workflow files:**
1. ✅ Check WORKFLOW_REFERENCE_BASELINE.md for validated patterns
2. ✅ Review applicable reference workflow (ci-latest-release.yml or ci-comprehensive-build-test.yml)
3. ✅ Compare working vs failing patterns FIRST (not after 50 minutes)
4. ✅ Match shell configuration exactly (bash/pwsh flags matter)
5. ✅ Test hypothesis locally with exact directory structure
6. ✅ Verify root cause before implementing
7. ✅ Get explicit user approval before push
8. ✅ Verify ALL jobs in GitHub UI after push (not just locally)

**Key Learnings from CFL Campaign (2026-02-06):**
- ✅ PowerShell: Use `shell: pwsh` (simple) not `pwsh -NoProfile -NoLogo -NonInteractive -Command {0}` (too strict)
- ✅ Windows double build: `cmake --build` twice for reliability (from reference)
- ✅ PATH filtering: Exclude `CMakeFiles` and `CMake(C|CXX)CompilerId.exe` (from reference)
- ✅ Library targets: Must be conditional based on ENABLE_SHARED_LIBS
- ✅ Target property access: Wrap in `IF(TARGET ...)` guards
- ✅ wxWidgets: Can disable via sed in workflow (preserves source compatibility)
- ✅ Version headers: Generate in build directory (clean git working tree)

**Violations Prevented:**
- V020: False Narrative Loop (50 min on wrong diagnosis)
- V020-D: Ignored Working Reference (user had to tell agent)
- V020-F: Unauthorized Push (after "DO NOT PUSH")
- V021: Repeated workflow push without reference check

**Quick Check:**
```bash
# ALWAYS do this FIRST for workflow debugging (2 minutes vs 50 minutes)
curl -s https://raw.githubusercontent.com/xsscx/user-controllable-input/master/.github/workflows/ci-latest-release.yml | less

# Compare shell configurations
curl -s [reference] | grep -A 5 "shell:"

# Compare cmake invocations
curl -s [reference] | grep -A 10 "cmake.*Cmake"

# Full pattern library
view .copilot-sessions/governance/WORKFLOW_REFERENCE_BASELINE.md
```

**Common Issues:**
- ❌ Grep matches success messages ("Found X") instead of errors ("Could not find X")
- ❌ Grep matches apt output ("Building dependency tree") instead of CMake errors  
- ❌ Script prints "PASS" but exits 1 (needs explicit `exit 0`)
- ❌ PowerShell flags too strict (breaks on Windows)
- ❌ Library targets hardcoded (breaks STATIC_ONLY builds)
- ❌ Target property access unguarded (fails when target doesn't exist)
- ❌ Artifact paths guessed (0 files uploaded despite success)
- ❌ Cherry-picking executables (paths don't match build structure)
- ✅ Solution: Check reference workflow, match patterns exactly

**Artifact Upload Pattern (2026-02-06):**
```yaml
# ✅ CORRECT: Use entire Build directory
path: |
  Build
  LICENSE.md
  README.md
  docs/**

# ❌ WRONG: Guess at paths
path: |
  Build/Tools/IccDumpProfile/IccDumpProfile  # Actually Build/Tools/*/Tool/Tool
  Build/IccProfLib/libIccProfLib2*.so*      # Extension wildcards fail
```

**See:** `.copilot-sessions/governance/ARTIFACT_UPLOAD_PATTERNS_2026-02-06.md`

**See Full Documentation:** 
- `.copilot-sessions/governance/WORKFLOW_GOVERNANCE.md` (comprehensive guide)
- `.copilot-sessions/governance/WORKFLOW_REFERENCE_BASELINE.md` (validated patterns)

## V011 Prevention (2026-02-06)

**New Gates Added:**

| Pattern | Action | Required Verification | Violation Prevented |
|---------|--------|----------------------|---------------------|
| Build/Cmake/* | DELETE | Ask user (build system source) | V011 |
| **/CMakeLists.txt | DELETE | Ask user (build config) | V011 |
| **/*.cmake | DELETE | Ask user (build modules) | V011 |
| >5 files | DELETE | BATCH-PROCESSING-GATE | V011 |

**Enforcement:**
- Before `git add -A`: Run `git status` and count deletions
- If >5 deletions OR CMake files → STOP and ask user
- **NEVER** assume Build/* is all artifacts (Build/Cmake/ is SOURCE)
